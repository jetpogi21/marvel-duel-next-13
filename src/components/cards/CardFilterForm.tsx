//Generated by WriteToModelfilterform_tsx - ModelFilterForm.tsx
"use client";
import { useCardStore } from "@/hooks/cards/useCardStore";
import {
  CardFormikFilter,
  CardSearchParams,
} from "@/interfaces/CardInterfaces";
import { DEFAULT_LIMIT } from "@/utils/constants";
import { getFilterValueFromURL, getParamsObject } from "@/utils/utilities";
import { encodeParams } from "@/utils/utils";
import { Form, Formik, FormikHelpers, FormikProps } from "formik";
import React, { MouseEventHandler } from "react";
import {
  DEFAULT_FILTERS,
  CONTROL_OPTIONS,
} from "@/utils/constants/CardConstants";
import LimitSelector from "@/components/form/LimitSelector";
import { useURL } from "@/hooks/useURL";
import FormikControl from "@/components/form/FormikControl";
import { Button } from "@/components/ui/Button";
import { isEqual } from "lodash";
//Generated by ImportAllUseModelListHookBySeqModel
import useDeckList from "@/hooks/decks/useDeckList"; //Generated by ImportUseModelListHook
import useCardKeywordList from "@/hooks/card-keywords/useCardKeywordList"; //Generated by ImportUseModelListHook

const CardFilterForm: React.FC = () => {
  const { router, query, pathname } = useURL<CardSearchParams>();

  //SearchParams Variables
  const limit = query["limit"] || DEFAULT_LIMIT;

  const defaultFilters = DEFAULT_FILTERS;
  const initialValues: CardFormikFilter = getFilterValueFromURL(
    query,
    defaultFilters
  );

  //Tanstack queries
  //Generated by GetRequiredQueryFromTanstackBySeqModel
  //Generated by GetRequiredQueryFromTanstack
  const { data: deckList } = useDeckList();
  //Generated by GetRequiredQueryFromTanstack
  const { data: cardKeywordList } = useCardKeywordList();

  //Zustand stores
  const [setPage, setLastPage, setFetchCount, resetRowSelection] = useCardStore(
    (state) => [
      state.setPage,
      state.setLastPage,
      state.setFetchCount,
      state.resetRowSelection,
    ]
  );

  const handleFormikSubmit = (
    values: Partial<CardFormikFilter>,
    formik: FormikHelpers<CardFormikFilter>
  ) => {
    const params = {
      ...query,
      ...(getParamsObject(values, defaultFilters) as Partial<CardSearchParams>),
    };

    const newURL = `${pathname}?${encodeParams(params)}`;
    router.push(newURL);
    setFetchCount(true);
    setPage(1);
    setLastPage(1);
    resetRowSelection();
  };

  const handleLimitChange = (value: string) => {
    const params = { ...query, limit: value };
    const newURL = `${pathname}?${encodeParams(params)}`;
    router.push(newURL);
    resetRowSelection();
  };

  const renderFormik = (formik: FormikProps<CardFormikFilter>) => {
    const filtered = isEqual(defaultFilters, formik.values);

    const handleSubmitClick: MouseEventHandler = (e) => {
      e.preventDefault();
      formik.submitForm();
    };

    const handleClearClick: MouseEventHandler = (e) => {
      e.preventDefault();
      formik.setValues(defaultFilters as CardFormikFilter);
      formik.submitForm();
    };

    return (
      <Form
        className="flex flex-col gap-2 w-[750px]"
        autoComplete="off"
      >
        <div className="flex flex-wrap gap-2">
          {/* Generated by GetFormikFilterQControl */}
          <FormikControl
            name="q"
            placeholder="Filter Cards..."
            type="Text"
            containerClassNames={["w-[200px]"]}
          />
          {/* Generated by GetAllFormikFilterControlBySeqModel */}
          {/* Generated by GetFacetedControl */}
          <FormikControl
            name="cardKeyword"
            options={cardKeywordList || []}
            label="Card Keyword"
            type="FacetedControl"
            containerClassNames={["min-w-[150px]"]}
          />
          {/* Generated by GetComboBoxControl - GetComboBoxControl */}
          <FormikControl
            name="battleStyle"
            options={CONTROL_OPTIONS.battleStyle}
            type="ComboBox"
            showLabel={false}
            label="Battle Style"
            containerClassNames={["w-[150px]"]}
          />
          {/* Generated by GetFacetedControl */}
          <FormikControl
            name="cost"
            options={CONTROL_OPTIONS.cost}
            label="Cost"
            type="FacetedControl"
          />
          {/* Generated by GetComboBoxControl - GetComboBoxControl */}
          <FormikControl
            name="deckId"
            options={deckList || []}
            type="ComboBox"
            showLabel={false}
            label="Deck"
            containerClassNames={["w-[150px]"]}
          />
          {/* Generated by GetComboBoxControl - GetComboBoxControl */}
          <FormikControl
            name="type"
            options={CONTROL_OPTIONS.type}
            type="ComboBox"
            showLabel={false}
            label="Type"
            containerClassNames={["w-[150px]"]}
          />
        </div>
        <div className="flex gap-2">
          <Button
            type="button"
            onClick={handleSubmitClick}
            size={"sm"}
            variant={"secondary"}
          >
            Search
          </Button>
          <Button
            type="button"
            size={"sm"}
            variant={"ghost"}
            disabled={filtered}
            onClick={handleClearClick}
          >
            Clear
          </Button>
        </div>
      </Form>
    );
  };

  return (
    <div className="flex items-start justify-between w-full">
      <Formik
        initialValues={initialValues}
        onSubmit={handleFormikSubmit}
      >
        {renderFormik}
      </Formik>
      <LimitSelector
        handleLimitChange={handleLimitChange}
        value={limit}
      />
    </div>
  );
};

export default CardFilterForm;
